import { Router } from 'express';
import { config } from '../config.js';

const REPORT_MAX = config.reportMaxRows;

function escapeHtml(s) {
  if (s == null) return '';
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function sanitize(str, maxLen = 500) {
  if (typeof str !== 'string') return '';
  return escapeHtml(str).slice(0, maxLen);
}

export const reportRouter = Router();

reportRouter.post('/html', (req, res) => {
  const {
    reportName = 'Report',
    description = '',
    columns = [],
    rows = [],
    chartSvgs = [],
    mapSvg = null,
  } = req.body || {};

  if (!Array.isArray(columns) || !Array.isArray(rows)) {
    return res.status(400).json({ success: false, error: 'columns and rows required' });
  }

  const colNames = columns.map(c => (typeof c === 'object' && c?.name) || String(c));
  const limitedRows = rows.slice(0, REPORT_MAX);

  const tableRows = limitedRows
    .map(
      row =>
        `<tr>${colNames.map((_, i) => `<td>${escapeHtml(String(row[i] ?? ''))}</td>`).join('')}</tr>`
    )
    .join('');

  const thead = `<thead><tr>${colNames.map(c => `<th>${escapeHtml(String(c))}</th>`).join('')}</tr></thead>`;
  const chartBlocks = (chartSvgs || [])
    .map(svg => (svg ? `<div class="chart">${svg}</div>` : ''))
    .filter(Boolean)
    .join('');
  const mapBlock = mapSvg ? `<div class="map">${mapSvg}</div>` : '';

  const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>${sanitize(reportName, 200)}</title>
  <style>
    @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
    body { font-family: system-ui, sans-serif; margin: 1rem; color: #222; }
    h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .description { margin-bottom: 1rem; color: #555; }
    table { border-collapse: collapse; width: 100%; margin: 1rem 0; font-size: 0.85rem; }
    th, td { border: 1px solid #ccc; padding: 0.35rem 0.5rem; text-align: left; }
    th { background: #f0f0f0; }
    .chart, .map { margin: 1.5rem 0; page-break-inside: avoid; }
    .chart svg, .map svg { max-width: 100%; height: auto; }
    @page { size: A4 landscape; margin: 1.5cm; }
  </style>
</head>
<body>
  <h1>${sanitize(reportName, 200)}</h1>
  ${description ? `<div class="description">${sanitize(description, 2000)}</div>` : ''}
  ${chartBlocks}
  ${mapBlock}
  <table>
    ${thead}
    <tbody>${tableRows}</tbody>
  </table>
  <p style="font-size: 0.8rem; color: #666;">Rows: ${limitedRows.length}${rows.length > REPORT_MAX ? ` (showing first ${REPORT_MAX})` : ''}. Generated by IoT Query Probe.</p>
</body>
</html>`;

  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.setHeader('Content-Disposition', 'inline; filename="report.html"');
  res.send(html);

  auditLog('report_html', { userId: req.user?.userId, rowCount: limitedRows.length });
});
